<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>GetUserMedia实例</title>
</head>
<body>
<video id="yourvideo" autoplay></video>
<video id="therevideo" autoplay></video>
</body>


<script type="text/javascript">
    var getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
    var theirvideo = document.getElementById('therevideo');
    function hasRTCPeerConnection() {
        window.RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection || window.msRTCPeerConnection;
        return !!window.RTCPeerConnection;
    }
    getUserMedia.call(navigator, {
        video: true,
        audio: true
    }, function(localMediaStream) {
        var video = document.getElementById('yourvideo');
        video.src = window.URL.createObjectURL(localMediaStream);
//        video.onloadedmetadata = function(e) {
//            console.log("Label: " + localMediaStream.label);
//            console.log("AudioTracks" , localMediaStream.getAudioTracks());
//            console.log("VideoTracks" , localMediaStream.getVideoTracks());
//        };
        if(hasRTCPeerConnection()){
            startPeerConnection(localMediaStream);
        }else {
            alert("没有RTCPeerConnection API");
        }
    }, function(e) {
        console.log('Reeeejected!', e);
    });
    function startPeerConnection(stream) {
        var config = {
            'iceServers': [{ 'url': 'stun:stun.services.mozilla.com' }, { 'url': 'stun:stunserver.org' }, { 'url': 'stun:stun.l.google.com:19302' }]
        };
        yourConnection = new RTCPeerConnection(config);
        theirConnection = new RTCPeerConnection(config);
        yourConnection.onicecandidate = function(e) {
            if (e.candidate) {
                theirConnection.addIceCandidate(new RTCIceCandidate(e.candidate));
            }
        }
        theirConnection.onicecandidate = function(e) {
            if (e.candidate) {
                yourConnection.addIceCandidate(new RTCIceCandidate(e.candidate));
            }
        }
        theirConnection.onaddstream = function(e) {
            theirvideo.src = window.URL.createObjectURL(e.stream);
        }
        yourConnection.addStream(stream);

        yourConnection.createOffer().then(offer => {
            yourConnection.setLocalDescription(offer);
        theirConnection.setRemoteDescription(offer);
        theirConnection.createAnswer().then(answer => {
            theirConnection.setLocalDescription(answer);
        yourConnection.setRemoteDescription(answer);
    })
    });
    }
</script>


</html>
